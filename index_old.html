<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>æ¼”ç¿’ãƒ•ã‚¡ã‚¤ãƒ«ï¼šãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æŒ‡æ–‡å­—èªè­˜</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<style>
body{font-family:system-ui,sans-serif;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:white;text-align:center;margin:0;padding:1rem;min-height:100vh;}
.container{max-width:800px;margin:0 auto;background:rgba(255,255,255,0.1);border-radius:20px;padding:2rem;backdrop-filter:blur(10px);}
canvas{border:2px solid rgba(255,255,255,0.3);border-radius:15px;max-width:100%;height:auto;box-shadow:0 8px 32px rgba(0,0,0,0.3);}
button,input{margin:0.5rem;padding:0.8rem 1.5rem;font-size:1rem;border:none;border-radius:10px;cursor:pointer;transition:all 0.3s ease;}
button{background:linear-gradient(45deg, #ff6b6b, #ee5a24);color:white;font-weight:bold;}
button:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,0.3);}
button:disabled{background:#ccc;cursor:not-allowed;transform:none;}
input[type="file"]{background:rgba(255,255,255,0.2);color:white;padding:0.5rem;}
#prob{font-weight:bold;font-size:2rem;color:#ffd700;text-shadow:2px 2px 4px rgba(0,0,0,0.5);margin:1rem 0;padding:1rem;background:rgba(0,0,0,0.2);border-radius:15px;}
#status{font-size:1rem;color:#a8e6cf;margin:0.5rem;}
h2{margin:1rem 0;font-size:2.5rem;text-shadow:2px 2px 4px rgba(0,0,0,0.5);}
p{margin:1rem 0;font-size:1.1rem;opacity:0.9;}
.info-panel{background:rgba(255,255,255,0.1);border-radius:10px;padding:1rem;margin:1rem 0;text-align:left;}
</style>
</head>
<body>
<div class="container">
<h2>ğŸ¤Ÿ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æŒ‡æ–‡å­—èªè­˜ã‚·ã‚¹ãƒ†ãƒ </h2>
<p>æ•°å­— 1-9 ã®æŒ‡æ–‡å­—ã‚’èªè­˜ã—ã¾ã™ã€‚å·¦æ‰‹ãƒ»å³æ‰‹ã©ã¡ã‚‰ã§ã‚‚å¯¾å¿œï¼</p>

<div class="info-panel">
  <h3>ğŸ“‹ ä½¿ã„æ–¹</h3>
  <ol style="text-align:left;">
    <li>ä¸‹ã®ãƒœã‚¿ãƒ³ã‹ã‚‰ãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆJSONï¼‰ã‚’é¸æŠ</li>
    <li>ã€Œèªè­˜é–‹å§‹ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
    <li>ã‚«ãƒ¡ãƒ©ã«å‘ã‹ã£ã¦æŒ‡æ–‡å­—ã‚’è¡¨ç¤º</li>
    <li>èªè­˜çµæœãŒä¸‹ã«è¡¨ç¤ºã•ã‚Œã¾ã™</li>
  </ol>
</div>

<label style="display:block;margin:1rem 0;">
  ğŸ¤– ãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ« (JSON): 
  <input type="file" id="modelFile" accept=".json">
</label>

<div style="margin:1rem 0;">
  <button id="start">ğŸš€ èªè­˜é–‹å§‹</button>
  <button id="stop" disabled>â¹ï¸ åœæ­¢</button>
</div>

<div id="status">ãƒ¢ãƒ‡ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„</div>
<div id="prob">â€“</div>

<video id="input" style="display:none;"></video>
<canvas id="output" width="640" height="480"></canvas>

<div class="info-panel" style="margin-top:2rem;">
  <h3>ğŸ’¡ èªè­˜ã®ã‚³ãƒ„</h3>
  <ul style="text-align:left;">
    <li>æ‰‹ã‚’ã‚«ãƒ¡ãƒ©ã®ä¸­å¤®ã«é…ç½®ã—ã¦ãã ã•ã„</li>
    <li>æŒ‡ã®å½¢ã‚’ã¯ã£ãã‚Šã¨è¦‹ã›ã¦ãã ã•ã„</li>
    <li>èƒŒæ™¯ã¯ã‚·ãƒ³ãƒ—ãƒ«ãªã‚‚ã®ãŒè‰¯ã„ã§ã™</li>
    <li>é©åº¦ãªæ˜ã‚‹ã•ã®ç’°å¢ƒã§ä½¿ç”¨ã—ã¦ãã ã•ã„</li>
  </ul>
</div>
</div>

<script>
// --- ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€å­¦ç”ŸãŒç·¨é›†ã—ã‚„ã™ã„ã‚ˆã†ã«ä¸»è¦ãªé–¢æ•°ã‚„å¤‰æ•°ã®ã¿ã‚’è¨˜è¼‰ã—ã¦ã„ã¾ã™ ---

const video = document.getElementById('input');
const canvas = document.getElementById('output');
const ctx = canvas.getContext('2d');
const startBtn = document.getElementById('start');
const stopBtn  = document.getElementById('stop');
const probDiv  = document.getElementById('prob');
const statusDiv = document.getElementById('status');
let modelCoef, modelIntercept, classLabels, scMean, scScale;
let modelLoaded = false, sending = false; 

// --- ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿ã€softmax, predicté–¢æ•° (ã“ã®éƒ¨åˆ†ã¯å®Œæˆå½¢ã§æä¾›) ---
document.getElementById('modelFile').addEventListener('change', e=>{
  const file = e.target.files[0]; if(!file) return;
  statusDiv.textContent = 'ãƒ¢ãƒ‡ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...';
  file.text().then(txt=>{
    const obj = JSON.parse(txt);
    modelCoef = obj.coef; modelIntercept = obj.intercept; classLabels = obj.labels;
    scMean  = obj.mean; scScale = obj.scale; modelLoaded = true;
    startBtn.disabled = false; 
    statusDiv.textContent = 'âœ… ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿å®Œäº†ï¼èªè­˜ã‚’é–‹å§‹ã§ãã¾ã™';
    alert('ğŸ‰ ãƒ¢ãƒ‡ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼');
  }).catch(err => {
    statusDiv.textContent = 'âŒ ãƒ¢ãƒ‡ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ';
    console.error('Model loading error:', err);
  });
});
function softmax(arr){
  const ex = arr.map(Math.exp); const sum = ex.reduce((a,b)=>a+b); return ex.map(v=>v/sum);
}
function predict(vec){
  const scores = modelCoef.map((w,i)=>{
    let s = modelIntercept[i];
    for(let j=0;j<w.length;j++){ s += w[j]*vec[j]; } return s;
  });
  const probs = softmax(scores); const maxIdx = probs.indexOf(Math.max(...probs));
  return [classLabels[maxIdx], probs[maxIdx]];
}

// --- Mediapipe & ã‚«ãƒ¡ãƒ©ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— (ã“ã®éƒ¨åˆ†ã‚‚å®Œæˆå½¢ã§æä¾›) ---
const hands = new Hands({locateFile:file=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
hands.setOptions({maxNumHands:1,modelComplexity:1,minDetectionConfidence:0.5,minTrackingConfidence:0.5});
const camera = new Camera(video,{
  width:640,height:480,
  onFrame: async ()=>{ if(sending) return; sending = true; await hands.send({image: video}); sending = false; }
});

/**
 * MediapipeãŒæ‰‹ã®ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ã‚’æ¤œå‡ºã—ãŸã¨ãã«å‘¼ã³å‡ºã•ã‚Œã‚‹ãƒ¡ã‚¤ãƒ³ã®å‡¦ç†
 */
hands.onResults(res => {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(res.image,0,0,canvas.width,canvas.height);
  if (!modelLoaded || !res.multiHandLandmarks?.length) { probDiv.textContent = 'â€“'; return; }

  /* ---------- 1. 21ç‚¹ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯å–å¾— (ã“ã“ã¯å®Œæˆå½¢ã§æä¾›) ---------- */
  const lmRaw = res.multiHandLandmarks[0];
  let lm = lmRaw.map(p => [p.x, p.y]);

  // å·¦æ‰‹å¯¾å¿œï¼šå·¦æ‰‹ã®å ´åˆã¯xåº§æ¨™ã‚’åè»¢ã—ã¦å³æ‰‹ã¨ã—ã¦æ‰±ã†
  const handedness = res.multiHandedness?.[0]?.label;
  if (handedness === 'Left') {
    lm = lm.map(point => [1 - point[0], point[1]]);
  }


  /*
   * =================================================================
   * â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼
   * ã€èª²é¡Œã€‘ã“ã“ã‹ã‚‰ä¸‹ã®ãƒ‡ãƒ¼ã‚¿å‰å‡¦ç†ã‚’å®Ÿè£…ã—ã‚ˆã†ï¼
   * Pythonã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯(exp3_compare.ipynb)ã® `create_normalized_features` é–¢æ•°ã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚
   * â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼
   */

  /* ---------- 2. æ‰‹é¦–ã‚’åŸç‚¹ã«ç§»å‹•ï¼ˆä½ç½®ã®æ­£è¦åŒ–ï¼‰---------- */
  // ç›®çš„: æ‰‹ãŒç”»é¢ä¸Šã®ã©ã“ã«ã‚ã£ã¦ã‚‚åŒã˜ç‰¹å¾´ãŒå¾—ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚
  // Pythonã‚³ãƒ¼ãƒ‰: lm -= wrist
  const wrist = [...lm[0]]; // é‡è¦ãªã‚³ãƒ”ãƒ¼å‡¦ç†ã¯äºˆã‚è¨˜è¿°ã—ã¦ãŠãã¾ã™

  // JavaScriptã‚‰ã—ã„å®Ÿè£…ï¼šmapã‚’ä½¿ç”¨
  lm.forEach((point, i) => {
    lm[i] = [point[0] - wrist[0], point[1] - wrist[1]];
  });

  /* ---------- 3. ã‚¹ã‚±ãƒ¼ãƒ«æ­£è¦åŒ–ï¼ˆå¤§ãã•ã®æ­£è¦åŒ–ï¼‰---------- */
  // ç›®çš„: æ‰‹ã®å¤§ãã•ï¼ˆã‚«ãƒ¡ãƒ©ã¨ã®è·é›¢ï¼‰ãŒé•ã£ã¦ã‚‚åŒã˜ç‰¹å¾´ãŒå¾—ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚
  // Pythonã‚³ãƒ¼ãƒ‰: norm = np.linalg.norm(lm, axis=1).max(); lm /= norm

  // ã‚¹ãƒ†ãƒƒãƒ—A: å„ç‚¹ã¨åŸç‚¹(æ‰‹é¦–)ã¨ã®è·é›¢ã‚’è¨ˆç®—ã™ã‚‹ï¼ˆJavaScriptã‚‰ã—ã„å®Ÿè£…ï¼‰
  const distances = lm.map(point => Math.hypot(point[0], point[1]));
  
  // ã‚¹ãƒ†ãƒƒãƒ—B: è·é›¢ã®æœ€å¤§å€¤ã‚’è¦‹ã¤ã‘ã‚‹ï¼ˆã“ã“ã¯å®Œæˆå½¢ã§æä¾›ï¼‰
  const norm = Math.max(...distances) || 1; // è·é›¢ãŒ0ã®æ™‚ã®ã‚¨ãƒ©ãƒ¼ã‚’é˜²ããŸã‚ || 1 ã‚’ä»˜ã‘ã¾ã™

  // ã‚¹ãƒ†ãƒƒãƒ—C: å…¨ã¦ã®åº§æ¨™ã‚’ã€è·é›¢ã®æœ€å¤§å€¤(norm)ã§å‰²ã‚‹ï¼ˆJavaScriptã‚‰ã—ã„å®Ÿè£…ï¼‰
  lm.forEach((point, i) => {
    lm[i] = [point[0] / norm, point[1] / norm];
  });

  /* * â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²
   * å®Ÿè£…ã¯ã“ã“ã¾ã§ï¼
   * â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²
   */


  /* ---------- 4. ãƒ™ã‚¯ãƒˆãƒ«åŒ–ã€æ¨™æº–åŒ–ã€äºˆæ¸¬ (ã“ã“ã¯å®Œæˆå½¢ã§æä¾›) ---------- */
  const vec = lm.flat();
  const stdVec = vec.map((v,i) => (v - scMean[i]) / scScale[i]);
  const [pred, prob] = predict(stdVec);
  probDiv.textContent = `æ•°å­—: ${pred}  (ç¢ºä¿¡åº¦ ${prob.toFixed(2)})`;

  /* ---------- 5. æç”» (ã“ã“ã¯å®Œæˆå½¢ã§æä¾›) ---------- */
  drawConnectors(ctx, lmRaw, HAND_CONNECTIONS, {color:'#22c55e', lineWidth:3});
  drawLandmarks(ctx, lmRaw, {color:'#ef4444', radius:3});
});

// --- UIæ“ä½œé–¢é€£ (ã“ã®éƒ¨åˆ†ã‚‚å®Œæˆå½¢ã§æä¾›) ---
startBtn.disabled = true;
startBtn.onclick = ()=>{ 
  if(!modelLoaded){ alert("å…ˆã«ãƒ¢ãƒ‡ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ä¸‹ã•ã„"); return; }
  camera.start(); startBtn.disabled=true; stopBtn.disabled=false;
};
stopBtn.onclick = ()=>{
  camera.stop(); startBtn.disabled = false; stopBtn.disabled = true; probDiv.textContent = 'â€“';
};
</script>
</body>
</html>